<template id="waitingDevice">
	<div class="deviceWrapper">
		<div style="display: flex; flex-direction: column;">
			<div style="display: flex; flex-direction: row; justify-content: space-between; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid black">
				<h2>MAC</h2>
			</div>
			<input id="MAC_name" class="nameInput" placeholder="Name" type="text">
            <input id="MAC_length" class="nameInput" placeholder="Length" type="number">
		</div>
		<button id="MAC_connect" class="connectButton" style="align-self: center">
			<svg class="noevent" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve">
<g>
<g>
	<path d="M297.448,279.808c-5.533-5.532-14.505-5.532-20.038,0.001l-31.873,31.873l-45.219-45.219l31.873-31.874
		c5.534-5.534,5.534-14.506,0-20.039c-5.533-5.534-14.506-5.534-20.039,0l-31.873,31.874l-25.485-25.485
		c-5.533-5.534-14.506-5.534-20.039,0l-56.36,56.36c-39.275,39.274-41.73,101.64-7.364,143.801
		c-0.46,0.358-0.909,0.738-1.332,1.161l-65.548,65.55c-5.534,5.533-5.534,14.506,0,20.039c2.767,2.767,6.393,4.15,10.019,4.15
		c3.626,0,7.253-1.384,10.019-4.15l65.549-65.549c0.423-0.423,0.803-0.872,1.161-1.332c19.675,16.037,43.75,24.055,67.825,24.055
		c27.515,0,55.029-10.473,75.976-31.42l56.36-56.36c5.534-5.533,5.534-14.506,0-20.039l-25.485-25.485l31.873-31.873
		C302.982,294.314,302.982,285.341,297.448,279.808z M214.661,413.565c-30.845,30.843-81.029,30.843-111.874,0l-4.352-4.352
		c-30.844-30.844-30.844-81.03,0-111.874l46.34-46.34l116.227,116.226L214.661,413.565z"/>
</g>
</g>
<g>
<g>
	<path d="M507.849,24.19c5.534-5.533,5.534-14.505,0-20.039c-5.532-5.534-14.505-5.534-20.039,0l-65.549,65.548
		c-0.423,0.422-0.801,0.87-1.159,1.33c-19.112-15.613-42.816-24.104-67.827-24.104c-28.7,0-55.682,11.177-75.976,31.471
		l-56.36,56.36c-5.534,5.534-5.534,14.505,0,20.039L357.206,291.06c2.657,2.658,6.261,4.15,10.019,4.15
		c3.758,0,7.363-1.493,10.019-4.15l56.36-56.36c20.294-20.294,31.47-47.276,31.47-75.975c0-25.011-8.49-48.715-24.104-67.827
		c0.459-0.358,0.907-0.737,1.33-1.159L507.849,24.19z M413.565,214.662l-46.34,46.341L250.998,144.775l46.34-46.341
		c14.942-14.941,34.807-23.17,55.937-23.17c21.131,0,40.996,8.229,55.937,23.17l4.352,4.352
		c14.941,14.941,23.17,34.807,23.17,55.937C436.735,179.855,428.506,199.72,413.565,214.662z"/>
</g>
</g>
<g>
<g>
	<path d="M374.062,196.728l-58.79-58.791c-5.533-5.534-14.506-5.534-20.039,0c-5.534,5.534-5.534,14.505,0,20.039l58.791,58.791
		c2.767,2.767,6.393,4.15,10.019,4.15c3.626,0,7.253-1.383,10.019-4.15C379.596,211.233,379.596,202.262,374.062,196.728z"/>
</g>
</g>
<g>
<g>
	<path d="M218.149,352.641l-58.791-58.791c-5.533-5.533-14.506-5.533-20.039,0c-5.533,5.534-5.533,14.506,0.001,20.039
		l58.791,58.791c2.767,2.767,6.393,4.15,10.019,4.15c3.626,0,7.253-1.384,10.019-4.15
		C223.683,367.146,223.683,358.173,218.149,352.641z"/>
</g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g></g>
			</svg>
		</button>
	</div>
</template>

<template id="connectedDevice">
	<div class="deviceWrapper" style="align-self: flex-end;">
		<div style="display: flex; flex-direction: column;">
			<div style="display: flex; flex-direction: row; justify-content: space-between; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid black">
				<h2>Name</h2>
			</div>
			<a id="MAC_uptime" class="uptime" type="text">0D 00:00:00</a>
		</div>
		<button id="MAC_disconnect" class="disconnectButton">
			<svg class="noevent" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve">
<g>
<g>
	<path d="M297.448,279.808c-5.533-5.532-14.505-5.532-20.038,0.001l-31.873,31.873l-45.219-45.219l31.873-31.874
		c5.534-5.534,5.534-14.506,0-20.039c-5.533-5.534-14.506-5.534-20.039,0l-31.873,31.874l-25.485-25.485
		c-5.533-5.534-14.506-5.534-20.039,0l-56.36,56.36c-39.275,39.274-41.73,101.64-7.364,143.801
		c-0.46,0.358-0.909,0.738-1.332,1.161l-65.548,65.55c-5.534,5.533-5.534,14.506,0,20.039c2.767,2.767,6.393,4.15,10.019,4.15
		c3.626,0,7.253-1.384,10.019-4.15l65.549-65.549c0.423-0.423,0.803-0.872,1.161-1.332c19.675,16.037,43.75,24.055,67.825,24.055
		c27.515,0,55.029-10.473,75.976-31.42l56.36-56.36c5.534-5.533,5.534-14.506,0-20.039l-25.485-25.485l31.873-31.873
		C302.982,294.314,302.982,285.341,297.448,279.808z M214.661,413.565c-30.845,30.843-81.029,30.843-111.874,0l-4.352-4.352
		c-30.844-30.844-30.844-81.03,0-111.874l46.34-46.34l116.227,116.226L214.661,413.565z"/>
</g>
</g>
<g>
<g>
	<path d="M507.849,24.19c5.534-5.533,5.534-14.505,0-20.039c-5.532-5.534-14.505-5.534-20.039,0l-65.549,65.548
		c-0.423,0.422-0.801,0.87-1.159,1.33c-19.112-15.613-42.816-24.104-67.827-24.104c-28.7,0-55.682,11.177-75.976,31.471
		l-56.36,56.36c-5.534,5.534-5.534,14.505,0,20.039L357.206,291.06c2.657,2.658,6.261,4.15,10.019,4.15
		c3.758,0,7.363-1.493,10.019-4.15l56.36-56.36c20.294-20.294,31.47-47.276,31.47-75.975c0-25.011-8.49-48.715-24.104-67.827
		c0.459-0.358,0.907-0.737,1.33-1.159L507.849,24.19z M413.565,214.662l-46.34,46.341L250.998,144.775l46.34-46.341
		c14.942-14.941,34.807-23.17,55.937-23.17c21.131,0,40.996,8.229,55.937,23.17l4.352,4.352
		c14.941,14.941,23.17,34.807,23.17,55.937C436.735,179.855,428.506,199.72,413.565,214.662z"/>
</g>
</g>
<g>
<g>
	<path d="M374.062,196.728l-58.79-58.791c-5.533-5.534-14.506-5.534-20.039,0c-5.534,5.534-5.534,14.505,0,20.039l58.791,58.791
		c2.767,2.767,6.393,4.15,10.019,4.15c3.626,0,7.253-1.383,10.019-4.15C379.596,211.233,379.596,202.262,374.062,196.728z"/>
</g>
</g>
<g>
<g>
	<path d="M218.149,352.641l-58.791-58.791c-5.533-5.533-14.506-5.533-20.039,0c-5.533,5.534-5.533,14.506,0.001,20.039
		l58.791,58.791c2.767,2.767,6.393,4.15,10.019,4.15c3.626,0,7.253-1.384,10.019-4.15
		C223.683,367.146,223.683,358.173,218.149,352.641z"/>
</g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g></g>
			</svg>
		</button>
	</div>
</template>

<template id="connectButtonTemplate">
	<svg class="noevent" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve">
<g>
<g>
	<path d="M297.448,279.808c-5.533-5.532-14.505-5.532-20.038,0.001l-31.873,31.873l-45.219-45.219l31.873-31.874
		c5.534-5.534,5.534-14.506,0-20.039c-5.533-5.534-14.506-5.534-20.039,0l-31.873,31.874l-25.485-25.485
		c-5.533-5.534-14.506-5.534-20.039,0l-56.36,56.36c-39.275,39.274-41.73,101.64-7.364,143.801
		c-0.46,0.358-0.909,0.738-1.332,1.161l-65.548,65.55c-5.534,5.533-5.534,14.506,0,20.039c2.767,2.767,6.393,4.15,10.019,4.15
		c3.626,0,7.253-1.384,10.019-4.15l65.549-65.549c0.423-0.423,0.803-0.872,1.161-1.332c19.675,16.037,43.75,24.055,67.825,24.055
		c27.515,0,55.029-10.473,75.976-31.42l56.36-56.36c5.534-5.533,5.534-14.506,0-20.039l-25.485-25.485l31.873-31.873
		C302.982,294.314,302.982,285.341,297.448,279.808z M214.661,413.565c-30.845,30.843-81.029,30.843-111.874,0l-4.352-4.352
		c-30.844-30.844-30.844-81.03,0-111.874l46.34-46.34l116.227,116.226L214.661,413.565z"/>
</g>
</g>
<g>
<g>
	<path d="M507.849,24.19c5.534-5.533,5.534-14.505,0-20.039c-5.532-5.534-14.505-5.534-20.039,0l-65.549,65.548
		c-0.423,0.422-0.801,0.87-1.159,1.33c-19.112-15.613-42.816-24.104-67.827-24.104c-28.7,0-55.682,11.177-75.976,31.471
		l-56.36,56.36c-5.534,5.534-5.534,14.505,0,20.039L357.206,291.06c2.657,2.658,6.261,4.15,10.019,4.15
		c3.758,0,7.363-1.493,10.019-4.15l56.36-56.36c20.294-20.294,31.47-47.276,31.47-75.975c0-25.011-8.49-48.715-24.104-67.827
		c0.459-0.358,0.907-0.737,1.33-1.159L507.849,24.19z M413.565,214.662l-46.34,46.341L250.998,144.775l46.34-46.341
		c14.942-14.941,34.807-23.17,55.937-23.17c21.131,0,40.996,8.229,55.937,23.17l4.352,4.352
		c14.941,14.941,23.17,34.807,23.17,55.937C436.735,179.855,428.506,199.72,413.565,214.662z"/>
</g>
</g>
<g>
<g>
	<path d="M374.062,196.728l-58.79-58.791c-5.533-5.534-14.506-5.534-20.039,0c-5.534,5.534-5.534,14.505,0,20.039l58.791,58.791
		c2.767,2.767,6.393,4.15,10.019,4.15c3.626,0,7.253-1.383,10.019-4.15C379.596,211.233,379.596,202.262,374.062,196.728z"/>
</g>
</g>
<g>
<g>
	<path d="M218.149,352.641l-58.791-58.791c-5.533-5.533-14.506-5.533-20.039,0c-5.533,5.534-5.533,14.506,0.001,20.039
		l58.791,58.791c2.767,2.767,6.393,4.15,10.019,4.15c3.626,0,7.253-1.384,10.019-4.15
		C223.683,367.146,223.683,358.173,218.149,352.641z"/>
</g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g></g>
			</svg>
</template>

<template id="connectingTemplate">
	<svg class="noevent" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="margin: auto; background: none; display: block; shape-rendering: auto;" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
		<rect x="17.5" y="30" width="15" height="40" fill="#28292f">
		  <animate attributeName="y" repeatCount="indefinite" dur="1s" calcMode="spline" keyTimes="0;0.5;1" values="18;30;30" keySplines="0 0.5 0.5 1;0 0.5 0.5 1" begin="-0.2s"></animate>
		  <animate attributeName="height" repeatCount="indefinite" dur="1s" calcMode="spline" keyTimes="0;0.5;1" values="64;40;40" keySplines="0 0.5 0.5 1;0 0.5 0.5 1" begin="-0.2s"></animate>
		</rect>
		<rect x="42.5" y="30" width="15" height="40" fill="#28292f">
		  <animate attributeName="y" repeatCount="indefinite" dur="1s" calcMode="spline" keyTimes="0;0.5;1" values="20.999999999999996;30;30" keySplines="0 0.5 0.5 1;0 0.5 0.5 1" begin="-0.1s"></animate>
		  <animate attributeName="height" repeatCount="indefinite" dur="1s" calcMode="spline" keyTimes="0;0.5;1" values="58.00000000000001;40;40" keySplines="0 0.5 0.5 1;0 0.5 0.5 1" begin="-0.1s"></animate>
		</rect>
		<rect x="67.5" y="30" width="15" height="40" fill="#28292f">
		  <animate attributeName="y" repeatCount="indefinite" dur="1s" calcMode="spline" keyTimes="0;0.5;1" values="20.999999999999996;30;30" keySplines="0 0.5 0.5 1;0 0.5 0.5 1"></animate>
		  <animate attributeName="height" repeatCount="indefinite" dur="1s" calcMode="spline" keyTimes="0;0.5;1" values="58.00000000000001;40;40" keySplines="0 0.5 0.5 1;0 0.5 0.5 1"></animate>
		</rect></svg>
</template>


<div class="setupWrapper">

    <div id="waitingDevicesWrapper" class="devicesWrapper">
        <h1>Devices waiting to connect</h1>
    </div>

    <div id="connectedDevicesWrapper" class="devicesWrapper">
        <h1>Connected devices</h1>
    </div>
</div>
<script type="text/javascript">
    function sleep(milliseconds) {
        return new Promise(resolve => setTimeout(resolve, milliseconds));
    }


    function loadDevices() {

        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                let waitingDevices = JSON.parse(this.responseText);
                let waitingDevicesWrapper = document.getElementById("waitingDevicesWrapper");
                if (waitingDevicesWrapper.getElementsByClassName("deviceWrapper").length < waitingDevices.length) {
                    for (let device of waitingDevices) {
                        if (document.getElementById(device['mac'] + "_name") === null) {
                            let waitingDeviceTemplate = document.getElementById("waitingDevice").innerHTML;
                            waitingDeviceTemplate = waitingDeviceTemplate.split("MAC").join(device["mac"]);
                            waitingDevicesWrapper.innerHTML += waitingDeviceTemplate;
                        }
                    }
                    for (let button of document.getElementsByClassName("connectButton")) {
                        button.addEventListener("click", connect);
                    }
                } else if (waitingDevicesWrapper.getElementsByClassName("deviceWrapper").length > waitingDevices.length) {
                    let connectButtons = document.getElementsByClassName("connectButton");
                    for (let button of connectButtons) {
                        let mac = button.id.split("_")[0];
                        let deviceWrapper = button.parentNode;
                        let isInList = false;
                        for (let device of waitingDevices) {
                            if (device['mac'] == mac) isInList = true;
                        }
                        if (isInList == false) deviceWrapper.parentNode.removeChild(deviceWrapper);
                    }
                }
            }
        };
        xhttp.open("GET", "/waiting", true);
        xhttp.send();

        let xhttp2 = new XMLHttpRequest();
        xhttp2.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                let connectedDevices = JSON.parse(this.responseText);
                let connectedDevicesWrapper = document.getElementById("connectedDevicesWrapper");
                if (connectedDevicesWrapper.getElementsByClassName("deviceWrapper").length < connectedDevices.length) {
                    for (let device of connectedDevices) {
                        if (document.getElementById(device['mac'] + "_disconnect") === null) {
                            let connectedDeviceTemplate = document.getElementById("connectedDevice").innerHTML;
                            connectedDeviceTemplate = connectedDeviceTemplate.split("Name").join(device["name"]);
                            connectedDeviceTemplate = connectedDeviceTemplate.split("MAC").join(device["mac"]);
                            connectedDevicesWrapper.innerHTML += connectedDeviceTemplate;
                        }
                    }

                    for (let button of document.getElementsByClassName("disconnectButton")) {
                        button.addEventListener("click", disconnect);
                    }

                } else if (connectedDevicesWrapper.getElementsByClassName("deviceWrapper").length > connectedDevices.length) {
                    let disconnectButtons = document.getElementsByClassName("disconnectButton");
                    for (let button of disconnectButtons) {
                        let mac = button.id.split("_")[0];
                        let deviceWrapper = button.parentNode;
                        let isInList = false;
                        for (let device of connectedDevices) {
                            if (device['mac'] == mac) isInList = true;
                        }
                        if (isInList == false) deviceWrapper.parentNode.removeChild(deviceWrapper);
                    }
                }
            }
        }
        xhttp2.open("GET", "/connected", true);
        xhttp2.send();

    }

    loadInterval = setInterval(loadDevices, 1000);

    function connect(event) {
        let espName = event.target.parentNode.childNodes[1].childNodes[3].value;
        let length = event.target.parentNode.childNodes[1].childNodes[5].value;
        if (espName != "" && length != "") {
            event.target.innerHTML = document.getElementById("connectingTemplate").innerHTML;
            event.target.style.backgroundColor = "lightgray";
            event.target.parentNode.style.alignSelf = "flex-end";

            let data = {
                'mac': event.target.id.split("_")[0],
                'length': length,
                'name': espName
            }

            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 201) {

                    let response = JSON.parse(this.responseText);
                    let toBeRemoved = document.getElementById(response["mac"] + "_connect").parentNode;
                    toBeRemoved.parentNode.removeChild(toBeRemoved);
                    let xhttp = new XMLHttpRequest();
                    sleep(5000).then(console.log("Updating..."));
                    xhttp.open("POST", "/updateDevices", true);
                    xhttp.send();

                } else if (this.readyState == 4 && this.status == 409) {
                    event.target.innerHTML = document.getElementById("connectButtonTemplate").innerHTML;
                    event.target.style.backgroundColor = "#29b5a8";
                    event.target.parentNode.style.alignSelf = "flex-start";
                }

            }
            xhr.open("PUT", "/connect", true);
            xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
            xhr.send(JSON.stringify(data));
        }
    }

    function disconnect(event) {
        let mac = event.target.id.split("_")[0];
        if (mac != "") {

            let data = {
                'mac': mac
            }

            xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    let toBeRemoved = document.getElementById(mac + "_disconnect").parentNode;
                    toBeRemoved.parentNode.removeChild(toBeRemoved);
                }
            }
            xhr.open("POST", "/disconnect", true);
            xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
            xhr.send(JSON.stringify(data));
        }
    }
</script>